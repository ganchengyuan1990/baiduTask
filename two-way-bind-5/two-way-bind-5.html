<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>two-way-bind-5</title>
</head>
<body>
<div id="app">
    <p>姓名:{{user.name}}</p>
    <p>年龄:{{user.age}}</p>
</div>

<script>

    /*
     * 遍历属性walk
     * 转换属性convert
     * 需要绑定监听$watch
     * dom渲染render
     * 初始化init
     * */

    //    Vue构造函数将要把入口(entry)和data实例化
    let Vue = function (obj) {
        this.entry = document.querySelector(obj.el);
        this.data = {};
        this.init(obj);
    };

    /*    Vue.prototype.walk = function (obj) {
     for (let key in obj) {
     if (obj.hasOwnProperty(key)) {
     if (typeof obj[key] === 'object' && obj[key] !== null) {
     Vue.prototype.walk.call(this[key] = {}, obj[key]);
     //                    console.log(this.__proto__);
     } else {
     //                    this[key]=obj[key];
     //                    console.log(this);
     Vue.prototype.convert.call(this, key, obj[key])
     }
     }
     }
     };*/

    //    用来遍历输入的对象
    Vue.prototype.walk = function (output, input) {
        for (let key in input) {
            if (input.hasOwnProperty(key)) {
                if (typeof input[key] !== 'object' || input[key] === null) {
                    this.convert(output, key, input[key]);
                } else {
                    this.walk(output[key] = {}, input[key]);
                }
            }
        }
    };

    //    将输入转换成Vue实例上的访问器属性
    Vue.prototype.convert =
        function (ins, key, value) {
            let _value = value;
            let that = this;
            Object.defineProperty(ins, key, {
                configurable: true,
                enumerable: true,
                get: function () {
                    return _value;
                },
                set: function (newVal) {
                    if (newVal === null || typeof newVal !== 'object') {
                        _value = newVal;
                        that.render(that.data, that.entry);
                    } else {
                        delete ins[key];
//                        ins[key] = {};
                        that.walk(ins[key], newVal);
                        that.render(that.data, that.entry);
                    }
                }
            })
        };

    //        function (key, value) {
    //            Object.defineProperty(this, key, {
    //                configurable:true,
    //                enumerable:true,
    //                get:function () {
    //                    return value;
    //                }
    //            })
    //        };

    /*        function (key, value) {
     let _value = value;
     console.log(this);
     //                console.log(value);
     Object.defineProperty(this, key, {
     configurable: true,
     enumerable: true,
     get: function () {
     return _value;
     },
     set: function (newVal) {
     _value = newVal;
     //                        this.render();
     //                        console.log(that);
     }
     })
     };*/


    //            (function (key, value) {
    //            let _value = input;
    //            return () => {
    //                Object.defineProperty(this, key, {
    //                    configurable: true,
    //                    enumerable: true,
    //                    get: function () {
    //                        return _value;
    //                    },
    //                    set: function (newVal) {
    //                        _value = newVal;
    //                    }
    //                })
    //            }
    //        })();

    //    用来给某个属性绑定回调函数
    Vue.prototype.$watch = function (attr, fn) {

    };

    //    用来渲染页面
    Vue.prototype.render = (function () {
        let domCache;
        return function (data, entry) {
            console.log('render...');
            domCache = domCache || entry.innerHTML;
            let domInnerHtml = domCache;
            let reg = /{{.*}}/g;
            let templateArr = [];
            let cache;
            while (cache = reg.exec(domCache)) {
                templateArr.push(cache[0]);
            }
            templateArr.forEach(item => {
                cache = item.slice(2, -2).split('.');
                let storage = data;
                cache.forEach(item => {
                    storage = storage[item];
                });
                reg = new RegExp('{{' + cache.join('.') + '}}', 'g');
                domInnerHtml = domInnerHtml.replace(reg, storage);
            });
            entry.innerHTML = domInnerHtml;
        }
    }());

    //    初始化，遍历传入的对象转换成实例上的访问器，渲染一下页面
    Vue.prototype.init = function (obj) {
        this.walk(this.data, obj.data);
        this.render(this.data, this.entry);
    };


    /*(function () {
     let domCache;
     return function () {
     console.log('render...');
     domCache = domCache || this.entry.innerHTML;
     let domInnerHtml= domCache;
     let reg = /{{.*}}/g;
     let templateArr = [];
     let cache;
     //        let storage;
     while (cache = reg.exec(domCache)) {
     templateArr.push(cache[0]);
     }
     console.log(templateArr);
     templateArr.forEach(item => {
     cache = item.slice(2, -2).split('.');
     //            i=0;
     //            console.log(cache);
     let storage = this.data;
     //            while(storage&&storage[cache[i++]]){
     //                storage=storage[cache[i++]]
     //            }
     //            console.log(cache);
     //            console.log(storage[cache[i]][cache[i+1]]);
     cache.forEach(item => {
     storage = storage[item];
     });
     console.log(storage);
     reg = new RegExp('{{' + cache.join('.') + '}}', 'g');
     console.log(reg);
     domInnerHtml = domInnerHtml.replace(reg, storage);
     });
     this.entry.innerHTML = domInnerHtml;
     }
     }());*/


    /*
     function () {
     console.log('render');
     let domStr = this.entry.innerHTML;
     let reg = /{{.*}}/g;
     let templateArr = [];
     let cache;
     //        let storage;
     while (cache = reg.exec(domStr)) {
     templateArr.push(cache[0]);
     }
     reg = /{{.*}}/;
     //        console.log(templateArr);
     templateArr.forEach(item => {
     cache = item.slice(2, -2).split('.');
     //            i=0;
     //            console.log(cache);
     let storage = this.data;
     //            while(storage&&storage[cache[i++]]){
     //                storage=storage[cache[i++]]
     //            }
     //            console.log(cache);
     //            console.log(storage[cache[i]][cache[i+1]]);
     cache.forEach(item => {
     storage = storage[item];
     });
     //            console.log(storage);
     this.entry.innerHTML = this.entry.innerHTML.replace(reg, storage);
     });
     };
     */

    //    Vue.prototype.init = function () {
    //        this.render();
    //    };


    let app = new Vue({
        el: '#app',
        data: {
            user: {
                name: 'rennaiqian',
                age: 23
            },
            school: 'neu',
            major: 'ee'
        }
    });

    //    app.data.user.name={firstName:'naiqian',lastName:'ren'};
</script>
</body>
</html>